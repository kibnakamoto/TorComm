\documentclass[a4paper,12pt]{article}

\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{listings}
\usepackage[svgnames, table]{xcolor}


\geometry{
 a4paper,
 total={180mm,255mm},
 left=20mm,
 top=20mm,
 }

\definecolor{pseudoColor}{rgb}{0.94,0.94,0.93}

\lstdefinestyle{PseudoCode}{
    backgroundcolor=\color{pseudoColor},
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    stringstyle=\color{purple},
	keywordstyle=[1]\color{blue},
	keywordstyle=[2]\color{red},
	keywordstyle=[3]\color{cyan},
    numberstyle=\tiny\color{magenta},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=4
}

\lstdefinelanguage{Pseudo}{
		keywords={Generate, set, if, If, Else, Pause, Sleep},
	keywords=[2]{sha256, chacha},
	keywords=[3]{key},
}

\lstset{style=PseudoCode,language=Pseudo}

\hypersetup{
	linktoc=all,
	hidelinks=true
}

\title{
	\Huge TorComm - Secure P2P Communication \\
	\ \\
	\ \\
	\ \\
	\Large Documentation
}

\author{Taha Canturk\\kibnakanoto@protonmail.com}
\date{2024-05-20}

\begin{document}
\maketitle

\newpage


\newpage

\tableofcontents

\newpage

\pagenumbering{roman}

\section{Key Protector}

\subsection{What Is It}

The Key protector app in security folder is used to secure a 32-byte symmetric key, 2-byte port key, 32-byte pepper. The output is in a file named $keys$. The data in this file is used for securing the local data. It needs a 4-32 byte password generated and stored by you. 

To set the password, execute the $key$ file which would generate the $get\_keys$ executable which is the key protector program. Store a copy of $get\_keys$ in somewhere secure if you don't want to lose it. If you lose the $get\_keys$ and don't have the $keys$ file, then your key is forever lost.

\subsection{Algorithm}
The C++ code is in $security/key.cpp$, but the basic idea is as following:

\begin{figure}[htb]
\begin{small}
\begin{lstlisting}[language=pseudo, escapeinside={(*}{*)}]

Generate key, pepper, iv
Ask user for 4-32 byte password
(*$result = pepper \oplus password$*)
Use sha256(result) as symmetric key to encrypt key using chacha
Store sha256(result) as sha256(sha256(result))
Generate exe for getting key ((*$get\_keys$*)):
	Store sha256(sha256(result)), iv, encrypted key, pepper (excluding 3-bytes)

	Ask user for password:
		Guess 3 bytes of password of unknown pepper
		(*$result = pepper \oplus password$*)
		Compute sha256(sha256(result)) and compare with stored sha256(sha256(result)).
		if no match:
			Continue guessing all possible 3-bytes. Once done, let user guess again

		if user guessed more than once:
			If guessed 3 or 6 times and while guess count is smaller than 7:
				Pause for 10s
			Else if Every 5 guesses:
				Pause for 30s
		Sleep(random(1s,5s)) # make it a random range so that timing attacks aren't possible

		If not valid match:
			If more than 10 password inputs made:
				Delete everything in current directory
		Else:
			Decrypt encrypted key using sha256(result)
			Write decrypted key to file

			

\end{lstlisting}
\end{small}
\caption{Key Protector}\label{key_protector}
\end{figure}


\subsection{Security}

since 2/3-bytes of the pepper is not stored in the $get\_keys$ file, they need to be guessed with every password that is entered. If we say 3 bytes of the data needs to be guessed. then the number of combinations in password is multiplied with $256^3$.

e.g. if you have a 4-digit pin as your password, then there are $10^4$ combinations in your password. Then the total number of combinations in password is $(256^3)(10^4) = 167772160000$.

This doesn't mean that your password needs to be smaller, it should still be 6-16 characters of numbers, small/capital letters, and symbols.

\end{document}
